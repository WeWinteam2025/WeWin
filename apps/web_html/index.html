<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>We Win</title>
    <link rel="stylesheet" href="/src/style.css" />
    <script src="/config.js"></script>
  </head>
  <body class="min-h-screen bg-[color:var(--brand-bg)]">
    <header class="border-b border-slate-200 bg-[color:var(--brand-surface)]/80 backdrop-blur sticky top-0 z-50">
      <div class="mx-auto max-w-7xl px-6 py-4 flex items-center justify-between">
        <div class="flex items-center gap-2 text-xl font-semibold tracking-tight text-[color:var(--text-primary)]">
          <img src="/wewin-logo.svg" alt="WeWin" class="h-8 md:h-10 w-auto"/>
        </div>
        <nav class="flex items-center gap-4 text-sm text-[color:var(--text-primary)]">
          <a href="/" class="hover:opacity-80">Inicio</a>
          <a href="/dash/index.html" class="hover:opacity-80">Dashboard</a>
          <a href="/dash/proyectos.html" class="hover:opacity-80">Proyectos</a>
          <a href="/dash/energia.html" class="hover:opacity-80">Energía</a>
          <a href="/dash/ppa.html" class="hover:opacity-80">PPA</a>
          <a href="/dash/stakeholders.html" class="hover:opacity-80">Stakeholders</a>
          <a href="/dash/techos.html" class="hover:opacity-80">Techos</a>
          <a href="/dash/instaladores.html" class="hover:opacity-80">Instaladores</a>
          <a href="/dash/inversion.html" class="hover:opacity-80">Inversión</a>
          <a href="/dash/catalogo.html" class="hover:opacity-80">Catálogo</a>
          <a href="/blog/index.html" class="hover:opacity-80">Blog</a>
          <span id="auth-slot"></span>
        </nav>
      </div>
      <script>
        (function(){
          function renderAuth(){
            var slot = document.getElementById('auth-slot');
            if (!slot) return;
            var token = localStorage.getItem('access');
            if (!token){ slot.innerHTML = '<a href="/auth/login.html" class="hover:opacity-80">Ingresar</a>'; return; }
            var API = window.API_BASE || 'http://localhost:8001';
            fetch(API + '/api/me', { headers: { Authorization: 'Bearer ' + token }})
              .then(function(r){ return r.ok ? r.json() : null; })
              .then(function(me){
                var avatar = (me && me.avatar_url) ? me.avatar_url : 'https://www.gravatar.com/avatar/?d=identicon';
                slot.innerHTML = '<a href="/dash/profile.html" title="Perfil"><img src="'+avatar+'" style="width:32px;height:32px;border-radius:50%;vertical-align:middle"/></a>'+
                  '<button id="logout-btn" style="margin-left:8px" class="btn-primary">Salir</button>';
                var btn = document.getElementById('logout-btn');
                if (btn) btn.addEventListener('click', function(){
                  localStorage.removeItem('access');
                  localStorage.removeItem('refresh');
                  window.location.href = '/auth/login.html';
                });
              }).catch(function(){
                slot.innerHTML = '<a href="/dash/profile.html" title="Perfil"><div style="width:32px;height:32px;border-radius:50%;background:#9CA3AF;display:inline-block;vertical-align:middle"></div></a>'+
                  '<button id="logout-btn" style="margin-left:8px" class="btn-primary">Salir</button>';
                var btn = document.getElementById('logout-btn');
                if (btn) btn.addEventListener('click', function(){
                  localStorage.removeItem('access');
                  localStorage.removeItem('refresh');
                  window.location.href = '/auth/login.html';
                });
              });
          }
          document.addEventListener('DOMContentLoaded', renderAuth);
        })();
      </script>
    </header>
    <main>
      <!-- Hero con video banner -->
      <section class="mx-auto max-w-7xl px-0 md:px-6 pt-0 md:pt-6">
        <div class="relative overflow-hidden rounded-none md:rounded-2xl shadow-xl">
          <video id="hero-video" class="w-full h-[44vh] md:h-[60vh] object-cover" autoplay muted playsinline loop preload="auto" poster="/img/solar/bogota-norte.webp?v=1">
            <source src="/img_src/Video%20Home.mp4" type="video/mp4" />
            <source src="/img/solar/video-home.mp4" type="video/mp4" />
            <source src="/img/solar/video-17601957552621.mp4" type="video/mp4" />
          </video>
          <div class="absolute inset-0 bg-gradient-to-b from-black/20 via-black/20 to-black/50"></div>
          <div class="absolute inset-x-0 top-0 p-6 md:p-10 text-white flex flex-col justify-center h-full">
            <h1 class="text-3xl md:text-5xl font-bold leading-tight mb-3">Comunidad de Energía Solar</h1>
            <p class="text-base md:text-lg opacity-90 max-w-3xl">Conecta propietarios de techo, instaladores, compradores, inversionistas y comunidad en un solo lugar.</p>
            <div class="mt-5 flex flex-wrap items-center gap-3">
              <a href="/dash/index.html" class="btn-primary">Ir al Dashboard</a>
              <a href="#activos" class="inline-flex items-center px-4 py-2 rounded border border-white/30 bg-white/10 hover:bg-white/20 transition">Ver Proyectos Activos</a>
              <button id="btn-health" class="inline-flex items-center px-4 py-2 rounded border border-white/30 bg-white/10 hover:bg-white/20 transition">Probar API</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Stakeholders superpuestos al video (glass cards) -->
      <section class="mx-auto max-w-7xl px-6 pb-12 -mt-10 md:-mt-16 relative z-10 grid md:grid-cols-5 gap-4">
        <div class="card bg-white/80 backdrop-blur ring-1 ring-black/5 shadow-lg">
          <h3 class="text-lg font-semibold mb-2">Propietarios de techo</h3>
          <p class="text-[color:var(--text-secondary)]">Monetiza tu techo con energía solar y contratos PPA o leasing.</p>
        </div>
        <div class="card bg-white/80 backdrop-blur ring-1 ring-black/5 shadow-lg">
          <h3 class="text-lg font-semibold mb-2">Instaladores</h3>
          <p class="text-[color:var(--text-secondary)]">Encuentra clientes y gestiona órdenes de trabajo con trazabilidad.</p>
        </div>
        <div class="card bg-white/80 backdrop-blur ring-1 ring-black/5 shadow-lg">
          <h3 class="text-lg font-semibold mb-2">Compradores / Comunidad</h3>
          <p class="text-[color:var(--text-secondary)]">Compra energía limpia a precios competitivos y participa en comunidades solares.</p>
        </div>
        <div class="card bg-white/80 backdrop-blur ring-1 ring-black/5 shadow-lg">
          <h3 class="text-lg font-semibold mb-2">Inversionistas</h3>
          <p class="text-[color:var(--text-secondary)]">Participa en proyectos con contratos de largo plazo y medición transparente.</p>
        </div>
        <div class="card bg-white/80 backdrop-blur ring-1 ring-black/5 shadow-lg">
          <h3 class="text-lg font-semibold mb-2">Gobierno / Aliados</h3>
          <p class="text-[color:var(--text-secondary)]">Impulsa esquemas de generación distribuida y transición energética.</p>
        </div>
      </section>

      <!-- Proyectos activos -->
      <section id="activos" class="mx-auto max-w-6xl px-6 pb-12">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-semibold">Proyectos activos</h2>
          <a href="/dash/proyectos.html" class="hover:opacity-80 text-sm">Ver todos</a>
        </div>
        <div id="projects-active" class="grid md:grid-cols-3 gap-4">Cargando proyectos…</div>
      </section>

      <!-- Noticias / Blog - Hero Slider -->
      <section class="mx-auto max-w-6xl px-6 pb-16">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-semibold">Noticias</h2>
          <a href="/blog/index.html" class="hover:opacity-80 text-sm">Ver blog</a>
        </div>
        <div id="news-slider" class="relative">
          <style>
            /* Oculta la barra inferior del carrusel */
            #news-track { scrollbar-width: none; -ms-overflow-style: none; }
            #news-track::-webkit-scrollbar { display: none; }
          </style>
          <div id="news-track" class="flex overflow-x-auto snap-x snap-mandatory scroll-smooth rounded-xl shadow-lg">
            <!-- Slide 1 -->
            <a href="/blog/comunidad-solar.html" class="relative min-w-full h-[360px] md:h-[420px] snap-start group">
              <img src="https://images.unsplash.com/photo-1509395176047-4a66953fd231?q=80&w=2000&auto=format&fit=crop" alt="Comunidad solar" class="absolute inset-0 w-full h-full object-cover" loading="lazy" referrerpolicy="no-referrer" crossorigin="anonymous"/>
              <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/20 to-black/10"></div>
              <div class="absolute bottom-0 left-0 right-0 p-6 md:p-8 text-white">
                <span class="inline-block text-xs uppercase tracking-wider opacity-80">Blog</span>
                <h3 class="text-2xl md:text-3xl font-semibold leading-snug">¿Qué es una comunidad de energía solar?</h3>
                <p class="mt-2 max-w-3xl opacity-90">Modelos, ventajas y participación de los stakeholders en América Latina.</p>
                <span class="inline-flex mt-4 items-center gap-2 px-3 py-1.5 rounded bg-white/10 ring-1 ring-white/20 group-hover:bg-white/20">Leer artículo →</span>
              </div>
            </a>
            <!-- Slide 2 -->
            <a href="/blog/ppa-para-pymes.html" class="relative min-w-full h-[360px] md:h-[420px] snap-start group">
              <img src="https://images.unsplash.com/photo-1526498460520-4c246339dccb?q=80&w=2000&auto=format&fit=crop" alt="PPA para PYMES" class="absolute inset-0 w-full h-full object-cover" loading="lazy" referrerpolicy="no-referrer" crossorigin="anonymous"/>
              <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/20 to-black/10"></div>
              <div class="absolute bottom-0 left-0 right-0 p-6 md:p-8 text-white">
                <span class="inline-block text-xs uppercase tracking-wider opacity-80">Guía</span>
                <h3 class="text-2xl md:text-3xl font-semibold leading-snug">PPA para PYMES</h3>
                <p class="mt-2 max-w-3xl opacity-90">Cómo acceder a energía limpia con contratos a largo plazo.</p>
                <span class="inline-flex mt-4 items-center gap-2 px-3 py-1.5 rounded bg-white/10 ring-1 ring-white/20 group-hover:bg-white/20">Leer artículo →</span>
              </div>
            </a>
            <!-- Slide 3 -->
            <a href="/blog/instaladores-calidad.html" class="relative min-w-full h-[360px] md:h-[420px] snap-start group">
              <img src="https://images.unsplash.com/photo-1581092921461-eab62e97a780?q=80&w=2000&auto=format&fit=crop" alt="Instaladores" class="absolute inset-0 w-full h-full object-cover" loading="lazy" referrerpolicy="no-referrer" crossorigin="anonymous"/>
              <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/20 to-black/10"></div>
              <div class="absolute bottom-0 left-0 right-0 p-6 md:p-8 text-white">
                <span class="inline-block text-xs uppercase tracking-wider opacity-80">Buenas prácticas</span>
                <h3 class="text-2xl md:text-3xl font-semibold leading-snug">Instaladores: calidad y trazabilidad</h3>
                <p class="mt-2 max-w-3xl opacity-90">Buenas prácticas de instalación y monitoreo.</p>
                <span class="inline-flex mt-4 items-center gap-2 px-3 py-1.5 rounded bg-white/10 ring-1 ring-white/20 group-hover:bg-white/20">Leer artículo →</span>
              </div>
            </a>
            <!-- Slide 4 -->
            <a href="/blog/financiacion-proyectos.html" class="relative min-w-full h-[360px] md:h-[420px] snap-start group">
              <img src="https://images.unsplash.com/photo-1540541338287-41700207dee6?q=80&w=2000&auto=format&fit=crop" alt="Financiación" class="absolute inset-0 w-full h-full object-cover" loading="lazy" referrerpolicy="no-referrer" crossorigin="anonymous"/>
              <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/20 to-black/10"></div>
              <div class="absolute bottom-0 left-0 right-0 p-6 md:p-8 text-white">
                <span class="inline-block text-xs uppercase tracking-wider opacity-80">Finanzas</span>
                <h3 class="text-2xl md:text-3xl font-semibold leading-snug">Financiación de proyectos solares</h3>
                <p class="mt-2 max-w-3xl opacity-90">Estructuras típicas, riesgos y métricas clave.</p>
                <span class="inline-flex mt-4 items-center gap-2 px-3 py-1.5 rounded bg-white/10 ring-1 ring-white/20 group-hover:bg-white/20">Leer artículo →</span>
              </div>
            </a>
          </div>
          <button id="news-prev" class="hidden md:flex items-center justify-center w-10 h-10 rounded-full bg-white shadow border border-slate-200 absolute left-3 top-1/2 -translate-y-1/2">‹</button>
          <button id="news-next" class="hidden md:flex items-center justify-center w-10 h-10 rounded-full bg-white shadow border border-slate-200 absolute right-3 top-1/2 -translate-y-1/2">›</button>
          <div id="news-dots" class="absolute bottom-3 left-1/2 -translate-x-1/2 flex gap-2"></div>
        </div>
      </section>
    </main>
    <footer class="border-t border-slate-200 bg-[color:var(--brand-surface)]">
      <div class="mx-auto max-w-7xl px-6 py-6 text-sm text-[color:var(--text-secondary)]">© 2025 WeWin</div>
    </footer>

    <script>
      (function(){
        const API = window.API_BASE || 'http://localhost:8001';
        const btn = document.getElementById('btn-health');
        if (btn) {
          btn.addEventListener('click', async () => {
            try {
              const r = await fetch(`${API}/healthz`);
              const t = await r.text();
              document.getElementById('health-result').innerText = r.ok ? t : `Error ${r.status}`;
            } catch(e){
              document.getElementById('health-result').innerText = 'Error de red';
            }
          });
        }
        // cargar 3 proyectos activos (o últimos 3)
        async function loadActiveProjects(){
          const slot = document.getElementById('projects-active');
          try {
            const r = await fetch(`${API}/api/projects/?limit=3&only_active=1`);
            if (!r.ok) { slot.innerHTML = 'No disponible.'; return; }
            let data = await r.json();
            if (!Array.isArray(data) && data?.results) data = data.results;
            if (!Array.isArray(data)) data = [];
            if (data.length === 0) { slot.innerHTML = '<div class="text-[color:var(--text-secondary)]">Sin proyectos activos.</div>'; return; }
            const ts = Date.now();
            function slugify(s){
              if (!s) return '';
              return String(s).toLowerCase()
                .replace(/[áàä]/g,'a').replace(/[éèë]/g,'e').replace(/[íìï]/g,'i')
                .replace(/[óòö]/g,'o').replace(/[úùü]/g,'u').replace(/ñ/g,'n')
                .replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
            }
            function solarFallback(p){
              const curated = [
                'https://images.unsplash.com/photo-1509391366360-2e959784a276?q=80&w=1600&auto=format&fit=crop&fm=webp',
                'https://images.unsplash.com/photo-1466611653911-95081537e5b7?q=80&w=1600&auto=format&fit=crop&fm=webp',
                'https://images.unsplash.com/photo-1592838064575-70ed626d3a0e?q=80&w=1600&auto=format&fit=crop&fm=webp'
              ];
              const slug = (p && p.slug) ? p.slug : slugify(p && p.ubicacion ? p.ubicacion : '');
              if (slug==='bogota-norte') return curated[0];
              if (slug==='medellin-sur') return curated[1];
              if (slug==='comunidad-energetica') return curated[2];
              const h = Math.abs((slug||'x').split('').reduce((a,c)=>((a<<5)-a)+c.charCodeAt(0),0));
              return curated[h % curated.length];
            }
            slot.innerHTML = data.slice(0,3).map(p => {
              const finalImg = solarFallback(p);
              const sep = finalImg.indexOf('?')>=0 ? '&' : '?';
              const busted = finalImg + sep + 'ts=' + ts;
              const slug = (p && p.slug) ? p.slug : slugify(p && p.ubicacion ? p.ubicacion : '');
              const cands = [];
              if (slug){
                if (p && p.id) cands.push('/img/solar/' + slug + '-' + p.id + '.webp?v=' + ts);
                cands.push('/img/solar/' + slug + '-b.webp?v=' + ts);
                cands.push('/img/solar/' + slug + '.webp?v=' + ts);
              }
              cands.push(busted);
              const listStr = cands.map(s=>s.replace(/"/g,'&quot;')).join('|');
              const first = cands[0] || busted;
              const imgTag = `<img src="${first}" data-i="0" onerror="(function(img){var L='${listStr}'.split('|');var i=(parseInt(img.dataset.i||'0',10)+1);if(i<L.length){img.dataset.i=i;img.src=L[i];}})(this)" alt="${p.ubicacion||''}" class="w-full h-40 object-cover rounded mb-3"/>`;
              const href = `/dash/proyecto.html?${p && p.slug ? ('slug='+slug) : ('id='+ (p && p.id ? p.id : ''))}&v=${ts}`;
              return `
                <a class="card block" href="${href}">
                  ${imgTag}
                  <div class="text-sm text-[color:var(--text-secondary)]">${p.tipo || ''}</div>
                  <div class="text-xl font-semibold mb-1">${p.ubicacion || 'Proyecto'}</div>
                  <div class="text-sm">Potencia: <strong>${p.potencia_kw} kW</strong></div>
                  <div class="text-sm">Estado: ${p.estado}</div>
                </a>
              `;
            }).join('');
          } catch(e){
            slot.innerHTML = '<div class="text-red-600">Error cargando proyectos.</div>';
          }
        }
        loadActiveProjects();

        // Noticias slider controls + dots
        const track = document.getElementById('news-track');
        const prev = document.getElementById('news-prev');
        const next = document.getElementById('news-next');
        const dots = document.getElementById('news-dots');
        if (track && dots){
          const slides = Array.from(track.querySelectorAll('a.min-w-full'));
          dots.innerHTML = slides.map((_,i)=>`<button data-i="${i}" class="w-2.5 h-2.5 rounded-full bg-white/40 hover:bg-white/70"></button>`).join('');
          function snapTo(idx){
            const w = track.clientWidth;
            track.scrollTo({ left: w*idx, behavior: 'smooth' });
            Array.from(dots.children).forEach((d,di)=>{ d.style.background = di===idx ? 'white' : 'rgba(255,255,255,0.4)'; });
          }
          let current = 0; snapTo(0);
          if (prev) prev.addEventListener('click', ()=>{ current = Math.max(0, current-1); snapTo(current); });
          if (next) next.addEventListener('click', ()=>{ current = Math.min(slides.length-1, current+1); snapTo(current); });
          dots.addEventListener('click', (e)=>{ const b=e.target.closest('button[data-i]'); if (b){ current = parseInt(b.dataset.i,10)||0; snapTo(current);} });
          // Auto-advance
          setInterval(()=>{ current = (current+1)%slides.length; snapTo(current); }, 7000);
        }
      })();
    </script>
  </body>
  </html>


