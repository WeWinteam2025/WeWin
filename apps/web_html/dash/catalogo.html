<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Catálogo</title>
    <link rel="stylesheet" href="/src/style.css" />
    <script src="/config.js"></script>
    <script src="https://unpkg.com/htmx.org@1.9.12" defer></script>
  </head>
  <body class="min-h-screen">
    <div class="mx-auto max-w-6xl px-6 py-8 space-y-6">
      <header class="border-b border-slate-200 bg-[color:var(--brand-surface)]/80 backdrop-blur sticky top-0 z-50">
        <div class="mx-auto max-w-7xl px-6 py-4 flex items-center justify-between">
          <div class="flex items-center gap-2 text-xl font-semibold tracking-tight text-[color:var(--text-primary)]">
            <img src="/wewin-logo.svg" alt="WeWin" class="h-8 md:h-10 w-auto"/>
          </div>
          <nav class="flex items-center gap-4 text-sm text-[color:var(--text-primary)]">
            <a href="/" class="hover:opacity-80">Inicio</a>
            <a href="/dash/index.html" class="hover:opacity-80">Dashboard</a>
            <a href="/dash/proyectos.html" class="hover:opacity-80">Proyectos</a>
            <a href="/dash/energia.html" class="hover:opacity-80">Energía</a>
            <a href="/dash/ppa.html" class="hover:opacity-80">PPA</a>
            <a href="/dash/stakeholders.html" class="hover:opacity-80">Stakeholders</a>
            <a href="/dash/techos.html" class="hover:opacity-80">Techos</a>
            <a href="/dash/instaladores.html" class="hover:opacity-80">Instaladores</a>
            <a href="/dash/inversion.html" class="hover:opacity-80">Inversión</a>
            <a href="/dash/catalogo.html" class="hover:opacity-80">Catálogo</a>
            <a href="/blog/index.html" class="hover:opacity-80">Blog</a>
            <a href="/dash/catalogo.html" id="cart-link" class="relative hover:opacity-80">Carrito <span id="cart-badge" class="ml-1 inline-flex items-center justify-center rounded-full bg-green-600 text-white text-[10px] leading-none px-1.5 py-0.5 align-top">0</span></a>
            <span id="auth-slot"></span>
          </nav>
        </div>
        <script>
          (function(){
            function renderAuth(slot){
              if (!slot) return;
              const token = localStorage.getItem('access');
              if (!token){ slot.innerHTML = '<a href="/auth/login.html" class="hover:opacity-80">Ingresar</a>'; return; }
              fetch((window.API_BASE|| (location.hostname.includes('wewin.space')?'https://api.wewin.space':'http://localhost:8001')) + '/api/profiles/?current=1', { headers:{ Authorization:'Bearer '+token }})
                .then(r=>r.ok?r.json():[]).then(data=>{
                  var profile = Array.isArray(data)? data[0] : (data?.value? data.value[0] : null);
                  var avatar = (profile && profile.avatar_url) ? profile.avatar_url : 'https://www.gravatar.com/avatar/?d=identicon';
                  slot.innerHTML = '<a href="/dash/profile.html" title="Perfil"><img src="'+avatar+'" style="width:32px;height:32px;border-radius:50%;vertical-align:middle"/></a>'+
                    '<button id=\"logout-btn\" style=\"margin-left:8px\" class=\"btn-primary\">Salir</button>';
                  var btn = document.getElementById('logout-btn');
                  if (btn) btn.addEventListener('click', function(){ localStorage.removeItem('access'); localStorage.removeItem('refresh'); location.href='/auth/login.html'; });
                }).catch(function(){ slot.innerHTML = '<a href="/auth/login.html" class="hover:opacity-80">Ingresar</a>'; });
            }
            document.addEventListener('DOMContentLoaded', function(){ renderAuth(document.getElementById('auth-slot')); });
          })();
        </script>
      </header>
      <h1 class="text-2xl font-semibold">Catálogo B2B</h1>
      <section class="card">
        <h2 class="text-lg font-semibold mb-3">Filtrar</h2>
        <form class="grid md:grid-cols-3 gap-2" onsubmit="event.preventDefault(); loadCatalog();">
          <input id="f_marca" class="input" placeholder="marca" />
          <input id="f_potencia" class="input" placeholder="potencia (W)" />
          <input id="f_stock" class="input" placeholder=">= stock" />
          <button class="btn-primary" type="submit">Buscar</button>
        </form>
      </section>
      <section class="grid md:grid-cols-3 gap-4" id="grid">Cargando...</section>
    </div>
    <script>
      function getAPI(){
        if (window.API_BASE) return window.API_BASE;
        if (location.hostname.includes('wewin.space')) return 'https://api.wewin.space';
        return 'http://localhost:8001';
      }
      function updateCartBadge(){
        try{ const cart = JSON.parse(localStorage.getItem('cart')||'[]'); document.getElementById('cart-badge').textContent = String(cart.reduce((a,i)=>a+(i.qty||1),0)); }catch{}
      }
      async function loadCatalog(){
        const params = new URLSearchParams();
        if (f_marca.value) params.append('marca', f_marca.value);
        if (f_potencia.value) params.append('potencia', f_potencia.value);
        if (f_stock.value) params.append('stock', f_stock.value);
        const res = await fetch(`${getAPI()}/api/products/?${params.toString()}`);
        let data = await res.json();
        if (!Array.isArray(data) && data?.value) data = data.value;
        if (!Array.isArray(data)) data = [];
        const fmtUSD = (n)=> new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(n);
        grid.innerHTML = data.map(p => {
          const vendor = p.vendor_org || (p.vendedor && p.vendedor.organization_name) || 'Proveedor';
          const tags = Object.entries(p.specs||{}).slice(0,4).map(([k,v])=>`<span class="badge">${k}: ${v}</span>`).join(' ');
          return `
          <div class="card">
            <div class="flex items-start justify-between">
              <div>
                <div class="text-xl font-semibold mb-1">${p.sku}</div>
                <div class="text-sm text-[color:var(--text-secondary)]">${vendor}${p.vendor_username ? ' • @'+p.vendor_username : ''}</div>
              </div>
              <div class="text-lg font-semibold">${fmtUSD(p.precio)}</div>
            </div>
            ${p.image_url ? `<img src="${p.image_url}" alt="${p.sku}" class="w-full h-32 object-cover rounded mt-2" loading="lazy"/>` : ''}
            <div class="mt-2 flex flex-wrap gap-2">${tags}</div>
            <div class="mt-3 flex items-center justify-between">
              <div class="text-sm text-[color:var(--text-secondary)]">Stock: ${p.stock}</div>
              <div class="flex gap-2 items-center">
                <input id="qty-${p.id}" class="input" type="number" min="1" value="1" style="max-width:120px" />
                <button class="btn-primary" onclick="order(${p.id})">Ordenar</button>
              </div>
            </div>
          </div>`;
        }).join('');
      }
      async function order(productId){
        const token = localStorage.getItem('access');
        if (!token){ alert('Inicia sesión para ordenar.'); location.href='/auth/login.html'; return; }
        const cantidad = Number(document.getElementById(`qty-${productId}`).value||1);
        try{
          const res = await fetch(`${getAPI()}/api/order/`,{ method:'POST', headers:{
            'Content-Type':'application/json', 'Authorization': 'Bearer '+token
          }, body: JSON.stringify({ producto: productId, cantidad })});
          const d = await res.json();
          if (res.ok){
            const cart = JSON.parse(localStorage.getItem('cart')||'[]');
            cart.push({ productId, qty: cantidad, total: d.total });
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartBadge();
            alert('Orden creada. Total: '+ (d.total||'OK'));
          }
          else { alert('No se pudo crear la orden.'); }
        }catch(e){ alert('Error de red'); }
      }
      loadCatalog();
      updateCartBadge();
    </script>
  </body>
  </html>




