<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>We Win • Dashboard</title>
    <link rel="stylesheet" href="/src/style.css" />
    <script src="/config.js"></script>
    <script src="https://unpkg.com/htmx.org@1.9.12" defer></script>
  </head>
  <body class="min-h-screen">
    <header class="border-b border-slate-200 bg-[color:var(--brand-surface)]/80 backdrop-blur">
      <div class="mx-auto max-w-7xl px-6 py-4 flex items-center justify-between">
        <div class="flex items-center gap-2 text-xl font-semibold tracking-tight text-[color:var(--text-primary)]">
          <img src="/wewin-logo.svg" alt="WeWin" class="h-8 md:h-10 w-auto"/>
        </div>
        <nav class="flex items-center gap-4 text-sm text-[color:var(--text-primary)]">
          <a href="/" class="hover:opacity-80">Inicio</a>
          <a href="/dash/index.html" class="hover:opacity-80">Dashboard</a>
          <a href="/dash/proyectos.html" class="hover:opacity-80">Proyectos</a>
          <a href="/dash/energia.html" class="hover:opacity-80">Energía</a>
          <a href="/dash/ppa.html" class="hover:opacity-80">PPA</a>
          <a href="/dash/stakeholders.html" class="hover:opacity-80">Stakeholders</a>
          <a href="/dash/techos.html" class="hover:opacity-80">Techos</a>
          <a href="/dash/instaladores.html" class="hover:opacity-80">Instaladores</a>
          <a href="/dash/inversion.html" class="hover:opacity-80">Inversión</a>
          <a href="/dash/catalogo.html" class="hover:opacity-80">Catálogo</a>
          <span id="auth-slot"></span>
        </nav>
      </div>
      <script src="/navbar-init.js"></script>
    </header>
    <div class="mx-auto max-w-6xl px-6 py-8 space-y-8">
      <h1 class="text-2xl font-semibold">Dashboard</h1>

      <section class="card">
        <h2 class="text-lg font-semibold mb-3">Catálogo (productos)</h2>
        <form class="mb-4 space-y-2" hx-post="" hx-target="#products-flash" hx-swap="innerHTML" onsubmit="this.setAttribute('hx-post', (window.API_BASE||'') + '/api/products');">
          <div class="grid md:grid-cols-4 gap-2">
            <input name="sku" placeholder="SKU" required />
            <input name="precio" type="number" min="0" step="0.01" placeholder="Precio" required />
            <input name="stock" type="number" min="0" placeholder="Stock" required />
            <button class="btn-primary" hx-on::after-request="this.closest('form').reset()">Crear producto</button>
          </div>
        </form>
        <div id="products-flash" class="text-sm text-[color:var(--text-secondary)] mb-2"></div>
        <div id="products-list" hx-get="" hx-trigger="load" hx-swap="innerHTML" onload="this.setAttribute('hx-get', (window.API_BASE||'') + '/api/products')">Cargando productos...</div>
      </section>

      <section class="card">
        <h2 class="text-lg font-semibold mb-3">Órdenes de trabajo</h2>
        <form class="mb-4 space-y-2" hx-post="" hx-target="#workorders-flash" hx-swap="innerHTML" onsubmit="this.setAttribute('hx-post', (window.API_BASE||'') + '/api/workorders');">
          <div class="grid md:grid-cols-4 gap-2">
            <input name="instalador" placeholder="actor_id instalador" required />
            <input name="proyecto" placeholder="proyecto_id" required />
            <input name="estado" placeholder="estado" required />
            <button class="btn-primary" hx-on::after-request="this.closest('form').reset()">Crear orden</button>
          </div>
        </form>
        <div id="workorders-flash" class="text-sm text-[color:var(--text-secondary)] mb-2"></div>
        <div id="workorders-list" hx-get="" hx-trigger="load" hx-swap="innerHTML" onload="this.setAttribute('hx-get', (window.API_BASE||'') + '/api/workorders')">Cargando órdenes...</div>
      </section>

      <section class="card">
        <h2 class="text-lg font-semibold mb-3">Comunidad Energética</h2>
        <div hx-get="" hx-trigger="load" hx-swap="innerHTML" onload="this.setAttribute('hx-get', (window.API_BASE||'') + '/api/ce')">Cargando CE...</div>
      </section>

      <section class="card">
        <h2 class="text-lg font-semibold mb-3">Paquetes de consultoría</h2>
        <div hx-get="" hx-trigger="load" hx-swap="innerHTML" onload="this.setAttribute('hx-get', (window.API_BASE||'') + '/api/consulting/packages')">Cargando paquetes...</div>
      </section>
    </div>
  </body>
  </html>
<script>
  // Autoriza todas las requests HTMX con el token
  document.addEventListener('htmx:configRequest', (evt) => {
    const token = localStorage.getItem('access');
    if (token) evt.detail.headers['Authorization'] = 'Bearer ' + token;
  });
  document.addEventListener('htmx:responseError', (e) => {
    const status = e.detail.xhr?.status;
    if (status === 401) alert('No autenticado. Inicia sesión.');
    else {
      const tgt = e.detail.target || document.querySelector('#products-flash');
      if (tgt) tgt.innerHTML = '<span class="text-red-600">' + (e.detail.xhr?.responseText || 'Error') + '</span>';
    }
  });
  document.addEventListener('htmx:afterRequest', (e) => {
    if (e.detail.successful) {
      const id = (e.detail.elt.closest('form')?.getAttribute('hx-target')) || '#products-flash';
      const tgt = document.querySelector(id);
      if (tgt) tgt.innerHTML = '<span class="text-green-600">Guardado correctamente</span>';
      // Refresh lists
      if (id.includes('products')) htmx.trigger('#products-list', 'load');
      if (id.includes('workorders')) htmx.trigger('#workorders-list', 'load');
    }
  });
</script>

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>We Win • Dashboard</title>
    <link rel="stylesheet" href="/src/style.css" />
    <script src="https://unpkg.com/htmx.org@1.9.12" defer></script>
  </head>
  <body class="min-h-screen">
    <div class="grid grid-cols-12 min-h-screen">
      <aside class="col-span-12 md:col-span-3 lg:col-span-2 border-r border-white/10 p-4">
        <div class="text-lg font-semibold mb-4">We Win</div>
        <nav class="space-y-2 text-sm">
          <a href="/dash/" class="block hover:opacity-80">Resumen</a>
          <a href="#" class="block hover:opacity-80">Ventas</a>
          <a href="#" class="block hover:opacity-80">Operaciones</a>
          <a href="#" class="block hover:opacity-80">Configuración</a>
        </nav>
      </aside>
      <main class="col-span-12 md:col-span-9 lg:col-span-10 p-6 space-y-6">
        <header class="flex items-center justify-between">
          <h1 class="text-2xl font-semibold">Resumen</h1>
          <a href="/" class="text-sm hover:opacity-80">Volver</a>
        </header>
        <section class="grid md:grid-cols-4 gap-4">
          <div class="card">
            <div class="badge-kpi"><span class="w-2 h-2 rounded-full bg-[color:var(--success)]"></span> Ventas (hoy)</div>
            <div class="mt-3 text-2xl font-semibold">$ 12.4k</div>
            <div class="text-[color:var(--text-secondary)] text-sm mt-1">+8.2% vs ayer</div>
          </div>
          <div class="card">
            <div class="badge-kpi"><span class="w-2 h-2 rounded-full bg-[color:var(--warning)]"></span> Órdenes pendientes</div>
            <div class="mt-3 text-2xl font-semibold">31</div>
            <div class="text-[color:var(--text-secondary)] text-sm mt-1">-3 desde ayer</div>
          </div>
          <div class="card">
            <div class="badge-kpi"><span class="w-2 h-2 rounded-full bg-[color:var(--brand-primary)]"></span> NPS</div>
            <div class="mt-3 text-2xl font-semibold">64</div>
            <div class="text-[color:var(--text-secondary)] text-sm mt-1">Estable</div>
          </div>
          <div class="card">
            <div class="badge-kpi"><span class="w-2 h-2 rounded-full bg-[color:var(--error)]"></span> Reclamos</div>
            <div class="mt-3 text-2xl font-semibold">7</div>
            <div class="text-[color:var(--text-secondary)] text-sm mt-1">+2 vs ayer</div>
          </div>
        </section>

        <section class="grid md:grid-cols-2 gap-4">
          <div class="card">
            <h3 class="text-lg font-semibold mb-4">Top productos</h3>
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="text-[color:var(--text-secondary)] text-left">
                  <tr>
                    <th class="py-2">Producto</th>
                    <th class="py-2">Ventas</th>
                    <th class="py-2">Ingreso</th>
                  </tr>
                </thead>
                <tbody>
                  <tr class="border-t border-white/10">
                    <td class="py-2">Tabla pino 2x4</td>
                    <td class="py-2">142</td>
                    <td class="py-2">$ 3,250</td>
                  </tr>
                  <tr class="border-t border-white/10">
                    <td class="py-2">Aglomerado 18mm</td>
                    <td class="py-2">85</td>
                    <td class="py-2">$ 5,120</td>
                  </tr>
                  <tr class="border-t border-white/10">
                    <td class="py-2">MDF 12mm</td>
                    <td class="py-2">97</td>
                    <td class="py-2">$ 2,980</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="card">
            <h3 class="text-lg font-semibold mb-4">Últimas órdenes</h3>
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="text-[color:var(--text-secondary)] text-left">
                  <tr>
                    <th class="py-2">#</th>
                    <th class="py-2">Cliente</th>
                    <th class="py-2">Estado</th>
                  </tr>
                </thead>
                <tbody>
                  <tr class="border-t border-white/10">
                    <td class="py-2">ORD-10243</td>
                    <td class="py-2">Acme S.A.</td>
                    <td class="py-2">En ruta</td>
                  </tr>
                  <tr class="border-t border-white/10">
                    <td class="py-2">ORD-10244</td>
                    <td class="py-2">MetalCo</td>
                    <td class="py-2">Pendiente</td>
                  </tr>
                  <tr class="border-t border-white/10">
                    <td class="py-2">ORD-10245</td>
                    <td class="py-2">WoodWorks</td>
                    <td class="py-2">Entregada</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>
      </main>
    </div>
  </body>
  </html>


