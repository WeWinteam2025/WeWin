<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>We Win • Dashboard Comunidad</title>
    <link rel="stylesheet" href="/src/style.css" />
    <script src="/config.js"></script>
    <script src="https://unpkg.com/htmx.org@1.9.12" defer></script>
  </head>
  <body class="min-h-screen">
    <header class="border-b border-slate-200 bg-[color:var(--brand-surface)]/80 backdrop-blur">
      <div class="mx-auto max-w-7xl px-6 py-4 flex items-center justify-between">
        <div class="flex items-center gap-2 text-xl font-semibold tracking-tight text-[color:var(--text-primary)]">
          <img src="/wewin-logo.svg" alt="WeWin" class="h-8 md:h-10 w-auto"/>
        </div>
        <nav class="flex items-center gap-4 text-sm text-[color:var(--text-primary)]">
          <a href="/" class="hover:opacity-80">Inicio</a>
          <a href="/dash/index.html" class="hover:opacity-80">Dashboard</a>
          <a href="/dash/proyectos.html" class="hover:opacity-80">Proyectos</a>
          <a href="/dash/energia.html" class="hover:opacity-80">Energía</a>
          <a href="/dash/ppa.html" class="hover:opacity-80">PPA</a>
          <a href="/dash/stakeholders.html" class="hover:opacity-80">Stakeholders</a>
          <a href="/dash/catalogo.html" class="hover:opacity-80">Catálogo</a>
          <a href="/dash/catalogo.html" id="cart-link" class="relative hover:opacity-80">
            Carrito <span id="cart-badge" class="ml-1 inline-flex items-center justify-center rounded-full bg-green-600 text-white text-[10px] leading-none px-1.5 py-0.5 align-top">0</span>
          </a>
          <span id="auth-slot"></span>
        </nav>
      </div>
      <script>
        (function(){
          function renderAuth(){
            var slot = document.getElementById('auth-slot');
            if (!slot) return;
            var token = localStorage.getItem('access');
            if (!token){ slot.innerHTML = '<a href="/auth/login.html" class="hover:opacity-80">Ingresar</a>'; return; }
            var API = window.API_BASE || 'http://localhost:8001';
            fetch(API + '/api/me', { headers: { Authorization: 'Bearer ' + token }})
              .then(function(r){ return r.ok ? r.json() : null; })
              .then(function(me){
                var avatar = (me && me.avatar_url) ? me.avatar_url : 'https://www.gravatar.com/avatar/?d=identicon';
                slot.innerHTML = '<a href="/dash/profile.html" title="Perfil"><img src="'+avatar+'" style="width:32px;height:32px;border-radius:50%;vertical-align:middle"/></a>'+
                  '<button id="logout-btn" style="margin-left:8px" class="btn-primary">Salir</button>';
                var btn = document.getElementById('logout-btn');
                if (btn) btn.addEventListener('click', function(){ localStorage.removeItem('access'); localStorage.removeItem('refresh'); window.location.href = '/auth/login.html'; });
              }).catch(function(){ slot.innerHTML = '<a href="/auth/login.html" class="hover:opacity-80">Ingresar</a>'; });
          }
          document.addEventListener('DOMContentLoaded', function(){
            renderAuth();
            // init cart badge
            try{
              var cart = JSON.parse(localStorage.getItem('cart')||'[]');
              document.getElementById('cart-badge').textContent = String(cart.reduce((a,i)=>a + (i.qty||1),0));
            }catch{}
          });
        })();
      </script>
    </header>

    <main class="mx-auto max-w-7xl px-6 py-10 space-y-10">
      <!-- Hero -->
      <section class="rounded-xl border border-slate-200 bg-[color:var(--brand-surface)] p-6 md:p-8">
        <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-6">
          <div>
            <h1 class="text-2xl md:text-3xl font-semibold">Panel de Comunidad Energética</h1>
            <p class="text-[color:var(--text-secondary)] mt-2">Monitorea ofertas y demandas de energía, participa en comunidades y gestiona tus acciones desde un solo lugar.</p>
          </div>
          <div class="flex gap-3">
            <a href="#acciones" class="btn-primary">Acciones rápidas</a>
            <a href="/blog/index.html" class="inline-flex items-center px-4 py-2 rounded border border-slate-300 bg-white hover:bg-slate-50">Aprender</a>
          </div>
        </div>
      </section>

      <!-- KPIs -->
      <section class="grid md:grid-cols-4 gap-4" id="kpis">
        <div class="card"><div class="badge-kpi">CE activas</div><div id="kpi-ce" class="mt-3 text-2xl font-semibold">—</div></div>
        <div class="card"><div class="badge-kpi">Oferta promedio (US$/kWh)</div><div id="kpi-oferta" class="mt-3 text-2xl font-semibold">—</div></div>
        <div class="card"><div class="badge-kpi">Demanda promedio (US$/kWh)</div><div id="kpi-demanda" class="mt-3 text-2xl font-semibold">—</div></div>
        <div class="card"><div class="badge-kpi">CO₂ evitado (t)</div><div id="kpi-co2" class="mt-3 text-2xl font-semibold">—</div></div>
      </section>

      <!-- Acciones rápidas -->
      <section id="acciones" class="grid md:grid-cols-3 gap-4">
        <div class="card">
          <h3 class="text-lg font-semibold mb-2">Publicar oferta</h3>
          <div id="gate-offer" class="hidden"></div>
          <form id="offer-form" class="space-y-2" hx-post="" hx-target="#offer-flash" hx-swap="innerHTML" onsubmit="this.setAttribute('hx-post', (window.API_BASE||'') + '/api/offers');">
            <input name="precio_ref" type="number" step="0.0001" min="0" placeholder="Precio US$/kWh" class="input" required />
            <input name="capacidad_kw" type="number" step="0.01" min="0" placeholder="Capacidad kW" class="input" required />
            <button class="btn-primary">Crear oferta</button>
            <div id="offer-flash" class="text-sm text-[color:var(--text-secondary)]"></div>
          </form>
        </div>
        <div class="card">
          <h3 class="text-lg font-semibold mb-2">Publicar demanda</h3>
          <div id="gate-demand" class="hidden"></div>
          <form id="demand-form" class="space-y-2" hx-post="" hx-target="#demand-flash" hx-swap="innerHTML" onsubmit="this.setAttribute('hx-post', (window.API_BASE||'') + '/api/demands');">
            <input name="precio_obj" type="number" step="0.0001" min="0" placeholder="Precio objetivo US$/kWh" class="input" required />
            <button class="btn-primary">Crear demanda</button>
            <div id="demand-flash" class="text-sm text-[color:var(--text-secondary)]"></div>
          </form>
        </div>
        <div class="card">
          <h3 class="text-lg font-semibold mb-2">Unirse a comunidad</h3>
          <p class="text-[color:var(--text-secondary)] mb-2">Explora comunidades activas y solicita ingreso.</p>
          <a href="/dash/energia.html" class="btn-primary">Ver comunidades</a>
        </div>
      </section>

      <!-- Listados de mercado -->
      <section class="grid md:grid-cols-3 gap-4">
        <div class="card">
          <h3 class="text-lg font-semibold mb-3">Ofertas públicas</h3>
          <div id="list-offers">Cargando...</div>
        </div>
        <div class="card">
          <h3 class="text-lg font-semibold mb-3">Demandas públicas</h3>
          <div id="list-demands">Cargando...</div>
        </div>
        <div class="card">
          <h3 class="text-lg font-semibold mb-3">Comunidades activas</h3>
          <div id="list-ce">Cargando...</div>
          <div class="text-right mt-2"><a href="/dash/stakeholders.html" class="text-sm hover:opacity-80">Ver detalle</a></div>
        </div>
      </section>

      <!-- Visualizaciones -->
      <section class="grid md:grid-cols-3 gap-4">
        <div class="card md:col-span-2">
          <h3 class="text-lg font-semibold mb-3">Ingresos estimados</h3>
          <canvas id="revChart" height="120"></canvas>
        </div>
        <div class="card">
          <h3 class="text-lg font-semibold mb-3">Proyectos en Colombia</h3>
          <div id="map" style="height:320px;border-radius:12px;overflow:hidden"></div>
        </div>
      </section>

      <!-- Mis proyectos -->
      <section class="grid md:grid-cols-3 gap-4">
        <div class="card md:col-span-1">
          <h3 class="text-lg font-semibold mb-3">Mis proyectos</h3>
          <div id="my-projects" class="text-sm text-[color:var(--text-secondary)]">Cargando...</div>
        </div>
        <div class="card md:col-span-2">
          <h3 class="text-lg font-semibold mb-3">Generación e ingresos (12 meses)</h3>
          <canvas id="myProjChart" height="120"></canvas>
        </div>
      </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      const API = window.API_BASE || 'http://localhost:8001';

      // HTMX auth header
      document.addEventListener('htmx:configRequest', (evt) => {
        const token = localStorage.getItem('access');
        if (token) evt.detail.headers['Authorization'] = 'Bearer ' + token;
      });

      // Inline login renderer
      function renderInlineLogin(targetId){
        const container = document.getElementById(targetId);
        if (!container) return;
        container.classList.remove('hidden');
        container.innerHTML = `
          <div class="rounded border border-slate-200 p-3 bg-white/60">
            <p class="mb-2">Inicia sesión para usar esta acción.</p>
            <form id="inline-login" class="grid grid-cols-1 gap-2 md:grid-cols-3 items-end">
              <input id="inline-user" class="input" placeholder="usuario o email" />
              <input id="inline-pass" type="password" class="input" placeholder="contraseña" />
              <button class="btn-primary" type="submit">Entrar</button>
            </form>
          </div>`;
        const form = document.getElementById('inline-login');
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          try {
            const username = document.getElementById('inline-user').value;
            const password = document.getElementById('inline-pass').value;
            const r = await fetch(`${API}/api/token/`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ username, password })});
            const d = await r.json();
            if (r.ok && d.access){ localStorage.setItem('access', d.access); if (d.refresh) localStorage.setItem('refresh', d.refresh); container.remove(); enableForms(); }
            else alert('Credenciales inválidas');
          } catch { alert('Error de red'); }
        });
      }

      function disableForms(){ ['offer-form','demand-form'].forEach(id=>{ const f=document.getElementById(id); if (f){ f.style.pointerEvents='none'; f.style.opacity='0.6'; }}); }
      function enableForms(){ ['offer-form','demand-form'].forEach(id=>{ const f=document.getElementById(id); if (f){ f.style.pointerEvents='auto'; f.style.opacity='1'; }}); }

      (function gate(){ const token = localStorage.getItem('access'); if (!token){ disableForms(); renderInlineLogin('gate-offer'); renderInlineLogin('gate-demand'); } })();

      async function safeJson(r){ try { return await r.json(); } catch { return []; } }
      function avg(arr, field){ const xs = arr.map(x=> Number(x[field]||0)).filter(n=>!isNaN(n) && isFinite(n)); if (!xs.length) return 0; return xs.reduce((a,b)=>a+b,0)/xs.length; }

      async function loadData(){
        try {
          const [offR, demR, ceR] = await Promise.all([
            fetch(`${API}/api/offers/public`),
            fetch(`${API}/api/demands/public`),
            fetch(`${API}/api/ce`)
          ]);
          let offers = await safeJson(offR); if (!Array.isArray(offers) && offers?.results) offers = offers.results; if (!Array.isArray(offers)) offers = [];
          let demands = await safeJson(demR); if (!Array.isArray(demands) && demands?.results) demands = demands.results; if (!Array.isArray(demands)) demands = [];
          let ce = await safeJson(ceR); if (!Array.isArray(ce) && ce?.results) ce = ce.results; if (!Array.isArray(ce)) ce = [];

          document.getElementById('kpi-ce').textContent = String(ce.length);
          const aO = avg(offers,'precio_ref');
          const aD = avg(demands,'precio_obj');
          document.getElementById('kpi-oferta').textContent = aO ? aO.toFixed(4) : '—';
          document.getElementById('kpi-demanda').textContent = aD ? aD.toFixed(4) : '—';
          const cap = offers.map(o=> Number(o.capacidad_kw||0)).filter(n=>!isNaN(n));
          const kwh = cap.reduce((a,b)=>a+b,0) * 4; // proxy diario
          const co2 = kwh * 0.45 / 1000; // tCO2 aprox por MWh
          document.getElementById('kpi-co2').textContent = co2 ? co2.toFixed(2) : '—';

          // render lists
          const fmt = (n)=> new Intl.NumberFormat('en-US',{maximumFractionDigits:4}).format(n);
          const offersHtml = offers.slice(0,6).map(o=>`<div class="border-b last:border-0 py-2 text-sm flex items-center justify-between"><span>${fmt(o.precio_ref||0)} US$/kWh</span><span class="text-[color:var(--text-secondary)]">${fmt(o.capacidad_kw||0)} kW</span></div>`).join('') || '<div class="text-[color:var(--text-secondary)]">Sin ofertas.</div>';
          document.getElementById('list-offers').innerHTML = offersHtml;
          const demandsHtml = demands.slice(0,6).map(d=>`<div class="border-b last:border-0 py-2 text-sm flex items-center justify-between"><span>${fmt(d.precio_obj||0)} US$/kWh</span><span class="text-[color:var(--text-secondary)]">${d.estado||''}</span></div>`).join('') || '<div class="text-[color:var(--text-secondary)]">Sin demandas.</div>';
          document.getElementById('list-demands').innerHTML = demandsHtml;
          const ceHtml = ce.slice(0,6).map(c=>`<div class="border-b last:border-0 py-2 text-sm flex items-center justify-between"><span>${c.nombre||'Comunidad'}</span><span class="text-[color:var(--text-secondary)]">${c.miembros||0} miembros</span></div>`).join('') || '<div class="text-[color:var(--text-secondary)]">Sin comunidades.</div>';
          document.getElementById('list-ce').innerHTML = ceHtml;

          // Render ingresos estimados (mock a partir de ofertas)
          const months = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
          const base = (aO || 0.22) * 10000; // proxy ingresos
          const series = months.map((_,i)=> (base * (0.9 + Math.sin(i/2)*0.05 + i*0.01)).toFixed(0));
          const ctx = document.getElementById('revChart');
          if (ctx && window.Chart){
            new Chart(ctx, { type:'line', data:{ labels: months, datasets:[{ label:'US$', data: series, borderColor:'#22c55e', backgroundColor:'rgba(34,197,94,0.15)', tension:0.35, fill:true }]}, options:{ plugins:{ legend:{ display:false }}, scales:{ y:{ ticks:{ callback:(v)=>'$'+v }}} }});
          }

          // Render mapa Colombia con proyectos (ubicación proxy por ciudad en nombre)
          const mapEl = document.getElementById('map');
          if (mapEl && window.L){
            const map = L.map('map').setView([4.7,-74.1], 5.2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);
            // Cargar proyectos públicos activos
            try{
              let pr = await fetch(`${API}/api/projects/?only_active=1&limit=50`);
              let pj = await safeJson(pr); if (!Array.isArray(pj) && pj?.results) pj = pj.results; if (!Array.isArray(pj)) pj = [];
              // Render markers (usa coordenadas si existen; si no, geolocalización simple por nombre)
              const fallbackGeo = {
                'bogota': [4.711, -74.072], 'medellin': [6.244, -75.581], 'cali':[3.452,-76.532], 'barranquilla':[10.963,-74.796],
                'cartagena':[10.391,-75.479], 'bucaramanga':[7.119,-73.123], 'pereira':[4.813,-75.696], 'manizales':[5.07,-75.52]
              };
              // Mostrar proyectos del usuario (si autenticado) y dibujar sólo esos puntos
              const token = localStorage.getItem('access');
              let mine = [];
              if (token){
                try{
                  const meR = await fetch(`${API}/api/me`, { headers:{ Authorization:'Bearer '+token }});
                  const me = await meR.json();
                  const username = (me?.username)||'';
                  if (username){
                    let mineR = await fetch(`${API}/api/projects/?owner_user=${encodeURIComponent(username)}&limit=10`);
                    mine = await safeJson(mineR); if (!Array.isArray(mine) && mine?.results) mine = mine.results; if (!Array.isArray(mine)) mine = [];
                  }
                }catch{}
              }
              if (mine.length === 0) mine = pj.slice(0,2);

              // Puntos en el mapa (solo mis proyectos)
              mine.forEach(p => {
                const lat = Number(p.lat), lng = Number(p.lng);
                let latlng;
                if (!isNaN(lat) && !isNaN(lng)) latlng = [lat, lng];
                else {
                  const name = String(p.ubicacion||'').toLowerCase();
                  const key = Object.keys(fallbackGeo).find(k => name.includes(k));
                  latlng = key ? fallbackGeo[key] : [4.7,-74.1];
                }
                L.marker(latlng).addTo(map).bindPopup(`<strong>${p.ubicacion||'Proyecto'}</strong><br/>${p.potencia_kw} kW • ${p.estado}<br/>${p.descripcion||''}`);
              });

              // Lista y gráfico de "Mis proyectos"
              const myEl = document.getElementById('my-projects');
              myEl.innerHTML = mine.length ? mine.map(p=>`${p.ubicacion} (${p.potencia_kw} kW)`).join(' • ') : 'Sin proyectos todavía.';

              // Cargar mediciones por proyecto y graficar 12 meses
              const last12 = (()=>{ const d=new Date(); const arr=[]; for(let i=11;i>=0;i--){ const dt=new Date(d.getFullYear(), d.getMonth()-i, 1); const y=dt.getFullYear(); const m=(dt.getMonth()+1).toString().padStart(2,'0'); arr.push(`${y}-${m}`);} return arr; })();
              const monthLabels = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
              const labels = last12.map(s=>{ const [y,m]=s.split('-'); return monthLabels[Number(m)-1]; });
              const USD_PER_KWH = 0.22;
              const seriesKwh = new Array(12).fill(0);
              // fetch measurements in parallel
              const meas = await Promise.all(mine.map(p => fetch(`${API}/api/measurements/?proyecto=${p.id}`).then(safeJson).catch(()=>[])));
              meas.forEach(arr => {
                (arr||[]).forEach(m => {
                  const idx = last12.indexOf(String(m.periodo||''));
                  if (idx >= 0) seriesKwh[idx] += Number(m.kwh_gen||0);
                });
              });
              const seriesUsd = seriesKwh.map(k => k * USD_PER_KWH);
              const ctx2 = document.getElementById('myProjChart');
              if (ctx2 && window.Chart){
                new Chart(ctx2, { type:'bar', data:{ labels, datasets:[
                  { type:'bar', label:'kWh', data: seriesKwh, backgroundColor:'rgba(59,130,246,0.4)' },
                  { type:'line', label:'US$', data: seriesUsd, borderColor:'#22c55e', yAxisID:'y1' },
                ]}, options:{ responsive:true, plugins:{ legend:{ display:true }}, scales:{ y:{ beginAtZero:true }, y1:{ position:'right', grid:{ drawOnChartArea:false }} } });
              }
            }catch{}
          }
        } catch(e){ console.warn(e); }
      }
      loadData();
    </script>
  </body>
  </html>


