<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>We Win • Dashboard Comunidad</title>
    <link rel="stylesheet" href="/src/style.css" />
    <script src="/config.js?v=1735248000"></script>
    <script src="https://unpkg.com/htmx.org@1.9.12" defer></script>
  </head>
  <body class="min-h-screen">
    <header class="border-b border-slate-200 bg-[color:var(--brand-surface)]/80 backdrop-blur">
      <div class="mx-auto max-w-7xl px-6 py-4 flex items-center justify-between">
        <div class="flex items-center gap-2 text-xl font-semibold tracking-tight text-[color:var(--text-primary)]">
          <img src="/wewin-logo.svg" alt="WeWin" class="h-8 md:h-10 w-auto"/>
        </div>
        <nav class="flex items-center gap-4 text-sm text-[color:var(--text-primary)]">
          <a href="/" class="hover:opacity-80">Inicio</a>
          <a href="/dash/index.html" class="hover:opacity-80">Dashboard</a>
          <a href="/dash/proyectos.html" class="hover:opacity-80">Proyectos</a>
          <a href="/dash/energia.html" class="hover:opacity-80">Energía</a>
          <a href="/dash/ppa.html" class="hover:opacity-80">PPA</a>
          <a href="/dash/stakeholders.html" class="hover:opacity-80">Stakeholders</a>
          <a href="/dash/catalogo.html" class="hover:opacity-80">Catálogo</a>
          <a href="/dash/catalogo.html" id="cart-link" class="relative hover:opacity-80">
            Carrito <span id="cart-badge" class="ml-1 inline-flex items-center justify-center rounded-full bg-green-600 text-white text-[10px] leading-none px-1.5 py-0.5 align-top">0</span>
          </a>
          <span id="auth-slot"></span>
        </nav>
      </div>
      <script>
        (function(){
          function renderAuth(){
            var slot = document.getElementById('auth-slot');
            if (!slot) return;
            var token = localStorage.getItem('access');
            if (!token){ slot.innerHTML = '<a href="/auth/login.html" class="hover:opacity-80">Ingresar</a>'; return; }
            var API = window.API_BASE || 'http://localhost:8001';
            fetch(API + '/api/me', { headers: { Authorization: 'Bearer ' + token }})
              .then(function(r){ return r.ok ? r.json() : null; })
              .then(function(me){
                var avatar = (me && me.avatar_url) ? me.avatar_url : 'https://www.gravatar.com/avatar/?d=identicon';
                slot.innerHTML = '<a href="/dash/profile.html" title="Perfil"><img src="'+avatar+'" style="width:32px;height:32px;border-radius:50%;vertical-align:middle"/></a>'+
                  '<button id="logout-btn" style="margin-left:8px" class="btn-primary">Salir</button>';
                var btn = document.getElementById('logout-btn');
                if (btn) btn.addEventListener('click', function(){ localStorage.removeItem('access'); localStorage.removeItem('refresh'); window.location.href = '/auth/login.html'; });
              }).catch(function(){ slot.innerHTML = '<a href="/auth/login.html" class="hover:opacity-80">Ingresar</a>'; });
          }
          document.addEventListener('DOMContentLoaded', function(){
            renderAuth();
            // init cart badge
            try{
              var cart = JSON.parse(localStorage.getItem('cart')||'[]');
              document.getElementById('cart-badge').textContent = String(cart.reduce((a,i)=>a + (i.qty||1),0));
            }catch{}
          });
        })();
      </script>
    </header>

    <main class="mx-auto max-w-7xl px-6 py-10 space-y-10">
      <!-- Hero -->
      <section class="rounded-xl border border-slate-200 bg-[color:var(--brand-surface)] p-6 md:p-8">
        <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-6">
          <div>
            <h1 class="text-2xl md:text-3xl font-semibold">Panel de Comunidad Energética</h1>
            <p class="text-[color:var(--text-secondary)] mt-2">Monitorea ofertas y demandas de energía, participa en comunidades y gestiona tus acciones desde un solo lugar.</p>
          </div>
          <div class="flex gap-3">
            <a href="#acciones" class="btn-primary">Acciones rápidas</a>
            <a href="/blog/index.html" class="inline-flex items-center px-4 py-2 rounded border border-slate-300 bg-white hover:bg-slate-50">Aprender</a>
          </div>
        </div>
      </section>

      <!-- KPIs -->
      <section class="grid md:grid-cols-4 gap-4" id="kpis">
        <div class="card"><div class="badge-kpi">CE activas</div><div id="kpi-ce" class="mt-3 text-2xl font-semibold">—</div></div>
        <div class="card"><div class="badge-kpi">Oferta promedio (US$/kWh)</div><div id="kpi-oferta" class="mt-3 text-2xl font-semibold">—</div></div>
        <div class="card"><div class="badge-kpi">Demanda promedio (US$/kWh)</div><div id="kpi-demanda" class="mt-3 text-2xl font-semibold">—</div></div>
        <div class="card"><div class="badge-kpi">CO₂ evitado (t)</div><div id="kpi-co2" class="mt-3 text-2xl font-semibold">—</div></div>
      </section>

      <!-- Acciones rápidas -->
      <section id="acciones" class="grid md:grid-cols-3 gap-4">
        <div class="card">
          <h3 class="text-lg font-semibold mb-2">Publicar oferta</h3>
          <div id="gate-offer" class="hidden"></div>
          <form id="offer-form" class="space-y-2" hx-post="" hx-target="#offer-flash" hx-swap="innerHTML" onsubmit="this.setAttribute('hx-post', (window.API_BASE||'') + '/api/offers');">
            <input name="precio_ref" type="number" step="0.0001" min="0" placeholder="Precio US$/kWh" class="input" required />
            <input name="capacidad_kw" type="number" step="0.01" min="0" placeholder="Capacidad kW" class="input" required />
            <button class="btn-primary">Crear oferta</button>
            <div id="offer-flash" class="text-sm text-[color:var(--text-secondary)]"></div>
          </form>
        </div>
        <div class="card">
          <h3 class="text-lg font-semibold mb-2">Publicar demanda</h3>
          <div id="gate-demand" class="hidden"></div>
          <form id="demand-form" class="space-y-2" hx-post="" hx-target="#demand-flash" hx-swap="innerHTML" onsubmit="this.setAttribute('hx-post', (window.API_BASE||'') + '/api/demands');">
            <input name="precio_obj" type="number" step="0.0001" min="0" placeholder="Precio objetivo US$/kWh" class="input" required />
            <button class="btn-primary">Crear demanda</button>
            <div id="demand-flash" class="text-sm text-[color:var(--text-secondary)]"></div>
          </form>
        </div>
        <div class="card">
          <h3 class="text-lg font-semibold mb-2">Unirse a comunidad</h3>
          <p class="text-[color:var(--text-secondary)] mb-2">Explora comunidades activas y solicita ingreso.</p>
          <a href="/dash/energia.html" class="btn-primary">Ver comunidades</a>
        </div>
      </section>

      <!-- Listados de mercado -->
      <section class="grid md:grid-cols-3 gap-4">
        <div class="card">
          <h3 class="text-lg font-semibold mb-3">Ofertas públicas</h3>
          <div id="list-offers">Cargando...</div>
        </div>
        <div class="card">
          <h3 class="text-lg font-semibold mb-3">Demandas públicas</h3>
          <div id="list-demands">Cargando...</div>
        </div>
        <div class="card">
          <h3 class="text-lg font-semibold mb-3">Comunidades activas</h3>
          <div id="list-ce">Cargando...</div>
          <div class="text-right mt-2"><a href="/dash/stakeholders.html" class="text-sm hover:opacity-80">Ver detalle</a></div>
        </div>
      </section>

      <!-- Visualizaciones -->
      <section class="grid md:grid-cols-3 gap-4">
        <div class="card md:col-span-2">
          <h3 class="text-lg font-semibold mb-3">Ingresos estimados</h3>
          <canvas id="revChart" height="120"></canvas>
        </div>
        <div class="card">
          <h3 class="text-lg font-semibold mb-3">Proyectos en Colombia</h3>
          <div id="map" style="height:320px;border-radius:12px;overflow:hidden"></div>
        </div>
      </section>

      <!-- Mis proyectos -->
      <section class="grid md:grid-cols-3 gap-4">
        <div class="card md:col-span-1">
          <h3 class="text-lg font-semibold mb-3">Mis proyectos</h3>
          <div id="my-projects" class="text-sm text-[color:var(--text-secondary)]">Cargando...</div>
        </div>
        <div class="card md:col-span-2">
          <h3 class="text-lg font-semibold mb-3">Generación e ingresos (12 meses)</h3>
          <canvas id="myProjChart" height="120"></canvas>
        </div>
      </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      (function(){
        var API = window.API_BASE || (location.hostname.indexOf('wewin.space')>=0?'https://api.wewin.space':'http://localhost:8001');
        
        function safeJson(r){ try { return r.json(); } catch { return []; } }
        function avg(arr, field){ 
          var xs = []; 
          for (var i=0;i<arr.length;i++){ 
            var n = Number(arr[i][field]||0); 
            if(!isNaN(n)&&isFinite(n)) xs.push(n);
          } 
          if(!xs.length) return 0; 
          var s=0; 
          for (var j=0;j<xs.length;j++) s+=xs[j]; 
          return s/xs.length; 
        }
        
        function setText(id, val){ var el=document.getElementById(id); if(el) el.textContent = val; }
        function setHTML(id, html){ var el=document.getElementById(id); if(el) el.innerHTML = html; }
        function fmt(n){ return new Intl.NumberFormat('en-US',{maximumFractionDigits:4}).format(n); }

        // HTMX auth header
        document.addEventListener('htmx:configRequest', function(evt){
          var token = localStorage.getItem('access');
          if (token) evt.detail.headers['Authorization'] = 'Bearer ' + token;
        });

        // Inline login renderer
        function renderInlineLogin(targetId){
          var container = document.getElementById(targetId);
          if (!container) return;
          container.classList.remove('hidden');
          var html = '';
          html += '<div class="rounded border border-slate-200 p-3 bg-white/60">';
          html += '<p class="mb-2">Inicia sesión para usar esta acción.</p>';
          html += '<form id="inline-login" class="grid grid-cols-1 gap-2 md:grid-cols-3 items-end">';
          html += '<input id="inline-user" class="input" placeholder="usuario o email" />';
          html += '<input id="inline-pass" type="password" class="input" placeholder="contraseña" />';
          html += '<button class="btn-primary" type="submit">Entrar</button>';
          html += '</form></div>';
          container.innerHTML = html;
          var form = document.getElementById('inline-login');
          form.addEventListener('submit', function(e){
            e.preventDefault();
            var username = document.getElementById('inline-user').value;
            var password = document.getElementById('inline-pass').value;
            fetch(API + '/api/token/', { 
              method:'POST', 
              headers:{'Content-Type':'application/json'}, 
              body: JSON.stringify({ username: username, password: password })
            })
            .then(function(r){ return r.json().then(function(d){ return { ok:r.ok, d:d }; }); })
            .then(function(res){ 
              if (res.ok && res.d && res.d.access){ 
                localStorage.setItem('access', res.d.access); 
                if (res.d.refresh) localStorage.setItem('refresh', res.d.refresh); 
                container.remove(); 
                enableForms(); 
              } else { 
                alert('Credenciales inválidas'); 
              } 
            })
            .catch(function(){ alert('Error de red'); });
          });
        }

        function disableForms(){ 
          ['offer-form','demand-form'].forEach(function(id){ 
            var f=document.getElementById(id); 
            if (f){ f.style.pointerEvents='none'; f.style.opacity='0.6'; }
          }); 
        }
        function enableForms(){ 
          ['offer-form','demand-form'].forEach(function(id){ 
            var f=document.getElementById(id); 
            if (f){ f.style.pointerEvents='auto'; f.style.opacity='1'; }
          }); 
        }

        function gate(){ 
          var token = localStorage.getItem('access'); 
          if (!token){ 
            disableForms(); 
            renderInlineLogin('gate-offer'); 
            renderInlineLogin('gate-demand'); 
          } 
        }

        async function loadData(){
          try {
            var offR = await fetch(API + '/api/offers/public');
            var demR = await fetch(API + '/api/demands/public');
            var ceR = await fetch(API + '/api/ce');
            
            var offers = await safeJson(offR); 
            if (!Array.isArray(offers) && offers && offers.results) offers = offers.results; 
            if (!Array.isArray(offers)) offers = [];
            
            var demands = await safeJson(demR); 
            if (!Array.isArray(demands) && demands && demands.results) demands = demands.results; 
            if (!Array.isArray(demands)) demands = [];
            
            var ce = await safeJson(ceR); 
            if (!Array.isArray(ce) && ce && ce.results) ce = ce.results; 
            if (!Array.isArray(ce)) ce = [];

            setText('kpi-ce', String(ce.length));
            var aO = avg(offers,'precio_ref');
            var aD = avg(demands,'precio_obj');
            setText('kpi-oferta', aO ? aO.toFixed(4) : '—');
            setText('kpi-demanda', aD ? aD.toFixed(4) : '—');
            
            var cap = offers.map(function(o){ return Number(o.capacidad_kw||0); }).filter(function(n){ return !isNaN(n); });
            var kwh = cap.reduce(function(a,b){ return a+b; }, 0) * 4;
            var co2 = kwh * 0.45 / 1000;
            setText('kpi-co2', co2 ? co2.toFixed(2) : '—');

            var offersHtml = offers.slice(0,6).map(function(o){ 
              return '<div class="border-b last:border-0 py-2 text-sm flex items-center justify-between"><span>'+fmt(o.precio_ref||0)+' US$/kWh</span><span class="text-[color:var(--text-secondary)]">'+fmt(o.capacidad_kw||0)+' kW</span></div>'; 
            }).join('') || '<div class="text-[color:var(--text-secondary)]">Sin ofertas.</div>';
            setHTML('list-offers', offersHtml);
            
            var demandsHtml = demands.slice(0,6).map(function(d){ 
              return '<div class="border-b last:border-0 py-2 text-sm flex items-center justify-between"><span>'+fmt(d.precio_obj||0)+' US$/kWh</span><span class="text-[color:var(--text-secondary)]">'+(d.estado||'')+'</span></div>'; 
            }).join('') || '<div class="text-[color:var(--text-secondary)]">Sin demandas.</div>';
            setHTML('list-demands', demandsHtml);
            
            var ceHtml = ce.slice(0,6).map(function(c){ 
              return '<div class="border-b last:border-0 py-2 text-sm flex items-center justify-between"><span>'+(c.nombre||'Comunidad')+'</span><span class="text-[color:var(--text-secondary)]">'+(c.miembros||0)+' miembros</span></div>'; 
            }).join('') || '<div class="text-[color:var(--text-secondary)]">Sin comunidades.</div>';
            setHTML('list-ce', ceHtml);

            // Render ingresos estimados
            var months = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
            var base = (aO || 0.22) * 10000;
            var series = months.map(function(_,i){ return (base * (0.9 + Math.sin(i/2)*0.05 + i*0.01)).toFixed(0); });
            var ctx = document.getElementById('revChart');
            if (ctx && window.Chart){
              new Chart(ctx, { 
                type:'line', 
                data:{ 
                  labels: months, 
                  datasets:[{ 
                    label:'US$', 
                    data: series, 
                    borderColor:'#22c55e', 
                    backgroundColor:'rgba(34,197,94,0.15)', 
                    tension:0.35, 
                    fill:true 
                  }]
                }, 
                options:{ 
                  plugins:{ legend:{ display:false }}, 
                  scales:{ y:{ ticks:{ callback:function(v){ return '$'+v; }}}} 
                }
              });
            }

            // Render mapa
            var mapEl = document.getElementById('map');
            if (mapEl && window.L){
              var map = L.map('map').setView([4.7,-74.1], 5.2);
              L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);
              
              var fallbackGeo = {
                'bogota': [4.711, -74.072], 'medellin': [6.244, -75.581], 'cali':[3.452,-76.532], 'barranquilla':[10.963,-74.796],
                'cartagena':[10.391,-75.479], 'bucaramanga':[7.119,-73.123], 'pereira':[4.813,-75.696], 'manizales':[5.07,-75.52]
              };
              
              var token = localStorage.getItem('access');
              var mine = [];
              if (token){
                try{
                  var meR = await fetch(API + '/api/me', { headers:{ Authorization:'Bearer '+token }});
                  var me = await meR.json();
                  var username = me && me.username ? me.username : '';
                  if (username){
                    var mineR = await fetch(API + '/api/projects/?owner_user=' + encodeURIComponent(username) + '&limit=10');
                    mine = await safeJson(mineR); 
                    if (!Array.isArray(mine) && mine && mine.results) mine = mine.results; 
                    if (!Array.isArray(mine)) mine = [];
                  }
                }catch(e){}
              }
              
              if (mine.length === 0) {
                try{
                  var pr = await fetch(API + '/api/projects/?only_active=1&limit=50');
                  var pj = await safeJson(pr); 
                  if (!Array.isArray(pj) && pj && pj.results) pj = pj.results; 
                  if (!Array.isArray(pj)) pj = [];
                  mine = pj.slice(0,2);
                }catch(e){}
              }

              mine.forEach(function(p) {
                var lat = Number(p.lat), lng = Number(p.lng);
                var latlng;
                if (!isNaN(lat) && !isNaN(lng)) {
                  latlng = [lat, lng];
                } else {
                  var name = String(p.ubicacion||'').toLowerCase();
                  var key = Object.keys(fallbackGeo).find(function(k) { return name.includes(k); });
                  latlng = key ? fallbackGeo[key] : [4.7,-74.1];
                }
                L.marker(latlng).addTo(map).bindPopup('<strong>'+(p.ubicacion||'Proyecto')+'</strong><br/>'+(p.potencia_kw)+' kW • '+(p.estado)+'<br/>'+(p.descripcion||''));
              });

              var myEl = document.getElementById('my-projects');
              myEl.innerHTML = mine.length ? mine.map(function(p){ return (p.ubicacion)+' ('+(p.potencia_kw)+' kW)'; }).join(' • ') : 'Sin proyectos todavía.';
            }
          } catch(e){ console.warn(e); }
        }
        
        // Initialize
        gate();
        loadData();
      })();
    </script>
  </body>
  </html>


