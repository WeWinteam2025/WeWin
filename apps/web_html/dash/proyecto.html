<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Proyecto</title>
    <link rel="stylesheet" href="/src/style.css" />
    <script src="/config.js?v=1735248000"></script>
    <script src="https://unpkg.com/htmx.org@1.9.12" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  </head>
  <body class="min-h-screen">
    <div class="mx-auto max-w-6xl px-6 py-8 space-y-6">
      <header class="border-b border-slate-200 bg-[color:var(--brand-surface)]/80 backdrop-blur sticky top-0 z-50">
        <div class="mx-auto max-w-7xl px-6 py-4 flex items-center justify-between">
          <div class="flex items-center gap-2 text-xl font-semibold tracking-tight text-[color:var(--text-primary)]">
            <img src="/wewin-logo.svg" alt="WeWin" class="h-8 md:h-10 w-auto"/>
          </div>
          <nav class="flex items-center gap-4 text-sm text-[color:var(--text-primary)]">
            <a href="/" class="hover:opacity-80">Inicio</a>
            <a href="/dash/index.html" class="hover:opacity-80">Dashboard</a>
            <a href="/dash/proyectos.html" class="hover:opacity-80">Proyectos</a>
            <a href="/dash/energia.html" class="hover:opacity-80">Energía</a>
            <a href="/dash/ppa.html" class="hover:opacity-80">PPA</a>
            <a href="/dash/stakeholders.html" class="hover:opacity-80">Stakeholders</a>
            <a href="/dash/techos.html" class="hover:opacity-80">Techos</a>
            <a href="/dash/instaladores.html" class="hover:opacity-80">Instaladores</a>
            <a href="/dash/inversion.html" class="hover:opacity-80">Inversión</a>
            <a href="/dash/catalogo.html" class="hover:opacity-80">Catálogo</a>
            <a href="/blog/index.html" class="hover:opacity-80">Blog</a>
            <span id="auth-slot"></span>
          </nav>
        </div>
        <script>
          (function(){
            function renderAuth(slot){
              if (!slot) return;
              var token = localStorage.getItem('access');
              if (!token){ slot.innerHTML = '<a href="/auth/login.html" class="hover:opacity-80">Ingresar</a>'; return; }
              fetch((window.API_BASE|| (location.hostname.indexOf('wewin.space')>=0?'https://api.wewin.space':'http://localhost:8001')) + '/api/profiles/?current=1', { headers:{ Authorization:'Bearer '+token }})
                .then(function(r){ return r.ok ? r.json() : []; })
                .then(function(data){
                  var profile = Array.isArray(data)? data[0] : ((data && data.value) ? data.value[0] : null);
                  var avatar = (profile && profile.avatar_url) ? profile.avatar_url : 'https://www.gravatar.com/avatar/?d=identicon';
                  slot.innerHTML = '<a href="/dash/profile.html" title="Perfil"><img src="'+avatar+'" style="width:32px;height:32px;border-radius:50%;vertical-align:middle"/></a>'+
                    '<button id=\"logout-btn\" style=\"margin-left:8px\" class=\"btn-primary\">Salir</button>';
                  var btn = document.getElementById('logout-btn');
                  if (btn) btn.addEventListener('click', function(){ localStorage.removeItem('access'); localStorage.removeItem('refresh'); location.href='/auth/login.html'; });
                })
                .catch(function(){ slot.innerHTML = '<a href="/auth/login.html" class="hover:opacity-80">Ingresar</a>'; });
            }
            document.addEventListener('DOMContentLoaded', function(){ renderAuth(document.getElementById('auth-slot')); });
          })();
        </script>
      </header>
      <div id="proj"></div>
      <section class="card">
        <h2 class="text-lg font-semibold mb-3">Mediciones</h2>
        <div id="proj-measurements">
          <button id="view-measurements-btn" class="btn-secondary">Ver historial de mediciones</button>
          <div id="measurements-summary" class="mt-2 text-sm text-[color:var(--text-secondary)]"></div>
        </div>
      </section>
      <section class="card">
        <h2 class="text-lg font-semibold mb-3">Resumen económico</h2>
        <div id="econ">Cargando...</div>
      </section>
      <section class="card">
        <h2 class="text-lg font-semibold mb-3">Ingresos acumulados vs inversión</h2>
        <canvas id="incomeChart" height="120"></canvas>
      </section>
      <section class="card">
        <h2 class="text-lg font-semibold mb-3">Rendimiento histórico</h2>
        <canvas id="perfChart" height="120"></canvas>
      </section>
    </div>

    <!-- Modal para mediciones -->
    <div id="measurements-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
      <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg max-w-4xl w-full max-h-[80vh] overflow-hidden">
          <div class="flex justify-between items-center p-4 border-b">
            <h3 class="text-lg font-semibold">Historial de Mediciones</h3>
            <button id="close-modal" class="text-gray-500 hover:text-gray-700">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          <div class="p-4 overflow-y-auto max-h-[60vh]">
            <div id="measurements-table"></div>
          </div>
        </div>
      </div>
    </div>
    <script>
      function getAPI(){ return (window.API_BASE || (location.hostname.indexOf('wewin.space')>=0?'https://api.wewin.space':'http://localhost:8001')); }
      const params = new URLSearchParams(window.location.search);
      let id = params.get('id');
      let slug = params.get('slug');

      function renderInlineLogin(targetId, onSuccess){
        var el = document.getElementById(targetId); if (!el) return;
        el.innerHTML = '<div class="max-w-md"><p class="mb-3">Inicia sesión para ver esta información.</p><form id="inline-login" class="space-y-3"><div><label class="block text-sm mb-1">Usuario o email</label><input id="inline-user" class="input" placeholder="demo" /></div><div><label class="block text-sm mb-1">Contraseña</label><input id="inline-pass" type="password" class="input" placeholder="••••••" /></div><button class="btn-primary" type="submit">Entrar</button></form></div>';
        var form = document.getElementById('inline-login');
        form.addEventListener('submit', function(e){
          e.preventDefault();
          var username = document.getElementById('inline-user').value;
          var password = document.getElementById('inline-pass').value;
          fetch(getAPI() + '/api/token/', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ username: username, password: password })})
            .then(function(r){ return r.json().then(function(d){ return {ok:r.ok, d:d}; }); })
            .then(function(x){ if (x.ok && x.d.access){ localStorage.setItem('access', x.d.access); if (x.d.refresh) localStorage.setItem('refresh', x.d.refresh); if (typeof onSuccess==='function') onSuccess(); } else { alert('Credenciales inválidas'); } })
            .catch(function(){ alert('Error de red'); });
        });
      }
      function ensureProjectId(){
        if (id && id !== 'ID') return Promise.resolve(id);
        if (slug){
          return fetch(getAPI() + '/api/projects/by_slug/?slug=' + encodeURIComponent(slug))
            .then(function(r){
              if (r.ok) {
                return r.json().then(function(p){
                  id = String(p.id);
                  return id;
                });
              }
              return null;
            })
            .catch(function(){
              return null;
            });
        }
        return Promise.resolve(null);
      }

      function loadProject(){
        ensureProjectId().then(function(pid){
          if (!pid){
            document.getElementById('proj').innerHTML = 'No hay proyectos para mostrar.';
            return;
          }
          fetch(getAPI() + '/api/projects/' + pid + '/')
            .then(function(res){
              if (!res.ok){
                document.getElementById('proj').innerHTML = 'No se pudo cargar el proyecto.';
                return;
              }
              return res.json();
            })
            .then(function(p){
              if (!p) return;
              // Información de comprador y vendedor
              var buyerInfo = '';
              var sellerInfo = '';
              if (p.buyer_info) {
                buyerInfo = '<div class="border-t border-slate-200 pt-3 mt-3"><div class="text-xs text-[color:var(--text-secondary)] mb-1">Comprador de energía</div><div class="text-sm font-medium">' + (p.buyer_info.organization || p.buyer_info.username || 'Empresa') + '</div><div class="text-xs text-[color:var(--text-secondary)]">Tarifa: $' + (p.buyer_info.tarifa || 0) + '/kWh</div></div>';
              }
              if (p.seller_info) {
                sellerInfo = '<div class="border-t border-slate-200 pt-3 mt-3"><div class="text-xs text-[color:var(--text-secondary)] mb-1">Generador de energía</div><div class="text-sm font-medium">' + (p.seller_info.organization || p.seller_info.username || 'Usuario') + '</div><div class="text-xs text-[color:var(--text-secondary)]">' + (p.seller_info.type || '') + '</div></div>';
              }
              
              document.getElementById('proj').innerHTML = 
                '<div class="card">' +
                ((p.image_src || p.image_url) ? '<img src="' + (p.image_src || p.image_url) + ((p.image_src||p.image_url).startsWith('data:')?'':'?ts='+Date.now()) + '" class="w-full h-56 object-cover rounded mb-4"/>' : '') +
                '<div class="text-sm text-[color:var(--text-secondary)] mb-2">' + (p.tipo || '') + '</div>' +
                '<h1 class="text-2xl font-semibold mb-2">' + (p.ubicacion || 'Proyecto') + '</h1>' +
                '<div class="text-sm mb-4">Potencia: <strong>' + (p.potencia_kw || 0) + ' kW</strong> • Estado: ' + (p.estado || '') + '</div>' +
                (p.descripcion ? '<div class="text-[color:var(--text-secondary)] text-sm leading-relaxed border-t border-slate-200 pt-4">' + (p.descripcion || '') + '</div>' : '') +
                buyerInfo + sellerInfo +
                '</div>';
            })
            .catch(function(e){
              document.getElementById('proj').innerHTML = 'Error de red al cargar proyecto.';
            });
        });
      }

      function loadMeasurements(){
        ensureProjectId().then(function(pid){
          if (!pid){
            document.getElementById('proj-measurements').innerHTML = 'No hay proyecto.';
            return;
          }
          // Sin headers de autenticación para mediciones públicas
          console.log('Fetching measurements for proyecto:', pid, 'API:', getAPI() + '/api/measurements/?proyecto=' + pid);
          fetch(getAPI() + '/api/measurements/?proyecto=' + pid)
            .then(function(res){
              console.log('Measurements response status:', res.status);
              if (!res.ok){
                console.error('Measurements fetch failed:', res.status, res.statusText);
                document.getElementById('proj-measurements').innerHTML = 'No se pudo cargar (status: ' + res.status + ').';
                return;
              }
              return res.json();
            })
            .then(function(data){
              if (!data) return;
              if (!Array.isArray(data) && data.value) data = data.value;
        if (!Array.isArray(data)) data = [];
              if (data.length === 0){
                document.getElementById('proj-measurements').innerHTML = 'Sin mediciones.';
                return;
              }
              // Mostrar resumen en lugar de tabla completa
              var totalKwh = data.reduce(function(a,m){ return a + Number(m.kwh_gen || 0); }, 0);
              var avgKwh = totalKwh / data.length;
              var latest = data[0];
              document.getElementById('measurements-summary').innerHTML = 
                '<div class="grid grid-cols-3 gap-4 text-center">' +
                '<div><div class="text-lg font-semibold">' + data.length + '</div><div class="text-xs">meses</div></div>' +
                '<div><div class="text-lg font-semibold">' + Math.round(avgKwh) + '</div><div class="text-xs">kWh/mes</div></div>' +
                '<div><div class="text-lg font-semibold">' + (latest.kwh_gen || 0) + '</div><div class="text-xs">último mes</div></div>' +
                '</div>';

              // Preparar tabla completa para el modal
              var tableRows = data.map(function(m){
                return '<tr class="border-t border-slate-200"><td class="py-2">' + (m.periodo || '') + '</td><td>' + (m.kwh_gen || 0) + '</td><td>' + (m.kwh_cons || 0) + '</td><td>' + (m.kwh_exced || 0) + '</td></tr>';
              }).join('');
              document.getElementById('measurements-table').innerHTML = 
                '<div class="overflow-x-auto">' +
                '<table class="w-full text-sm">' +
                '<thead class="text-left text-[color:var(--text-secondary)] bg-gray-50">' +
                '<tr><th class="py-3 px-2">Periodo</th><th class="py-3 px-2">kWh generados</th><th class="py-3 px-2">kWh consumidos</th><th class="py-3 px-2">Excedente</th></tr>' +
                '</thead>' +
                '<tbody>' + tableRows + '</tbody>' +
                '</table>' +
                '</div>';
              
              // Gráfico de rendimiento
              try{
                var ordered = data.slice().sort(function(a,b){ return String(a.periodo).localeCompare(String(b.periodo)); });
                var labels = ordered.map(function(m){ return m.periodo; });
                var series = ordered.map(function(m){ return Number(m.kwh_gen || 0); });
                var ctx = document.getElementById('perfChart');
                if (ctx && window.Chart){
                  new Chart(ctx, {
                    type: 'bar',
                    data: {
                      labels: labels,
                      datasets: [{
                        label: 'kWh generados',
                        data: series,
                        backgroundColor: 'rgba(34,197,94,0.5)'
                      }]
                    },
                    options: {
                      plugins: { legend: { display: false } },
                      scales: {
                        x: { ticks: { autoSkip: true, maxRotation: 0 } },
                        y: { beginAtZero: true }
                      }
                    }
                  });
                }
              }catch(e){}
              
              // Resumen económico
              var copPerKwh = 750;
              var totalKwh = data.reduce(function(a,m){ return a + Number(m.kwh_gen || 0); }, 0);
              var ingresoCop = totalKwh * copPerKwh;
              
              ensureProjectId().then(function(pid){
                fetch(getAPI() + '/api/projects/' + pid + '/')
                  .then(function(prRes){ return prRes.json(); })
                  .then(function(pr){
                    if (!pr) return;
                    var kw = Number(pr.potencia_kw || 0);
                    var panels = Math.round(kw / 0.55);
                    var capexUsd = Math.round(kw * 600);
                    var fmt = function(n, cur){
                      if (cur === 'COP') {
                        return new Intl.NumberFormat('es-CO', {style:'currency', currency:'COP', maximumFractionDigits:0}).format(n);
                      } else {
                        return new Intl.NumberFormat('en-US', {style:'currency', currency:'USD', maximumFractionDigits:0}).format(n);
                      }
                    };
                    var r = Math.pow(1+0.10,1/12)-1;
                    var ingresosMensuales = data.map(function(m){ return Number(m.kwh_gen || 0) * copPerKwh; });
                    var npv = 0;
                    ingresosMensuales.forEach(function(f,i){ npv += f/Math.pow(1+r, i+1); });
                    document.getElementById('econ').innerHTML = 
                      '<div class="grid md:grid-cols-3 gap-4">' +
                      '<div><div class="text-sm text-[color:var(--text-secondary)]">Ingreso estimado (18m)</div><div class="text-xl font-semibold">' + fmt(ingresoCop,'COP') + '</div></div>' +
                      '<div><div class="text-sm text-[color:var(--text-secondary)]">Paneles aprox</div><div class="text-xl font-semibold">' + panels + '</div></div>' +
                      '<div><div class="text-sm text-[color:var(--text-secondary)]">CAPEX aproximado</div><div class="text-xl font-semibold">' + fmt(capexUsd,'USD') + '</div></div>' +
                      '<div class="md:col-span-3"><div class="text-sm text-[color:var(--text-secondary)]">VPN (flujo generado a 10% anual)</div><div class="text-xl font-semibold">' + fmt(npv,'COP') + '</div></div>' +
                      '</div>';

                  // Ingresos acumulados vs inversión
                  try {
                    var labels = data.slice().sort(function(a,b){ return String(a.periodo).localeCompare(String(b.periodo)); }).map(function(m){ return m.periodo; });
                    var cumul = [];
                    var acc = 0;
                    for (var i=0;i<ingresosMensuales.length;i++){ acc += ingresosMensuales[i]; cumul.push(Math.round(acc)); }
                    var ictx = document.getElementById('incomeChart');
                    if (ictx && window.Chart){
                      new Chart(ictx, { type:'line', data:{ labels: labels, datasets:[
                        { label:'Ingresos acumulados (COP)', data: cumul, borderColor:'#16a34a', backgroundColor:'rgba(22,163,74,0.15)', fill:true, tension:0.3 },
                        { label:'Inversión (USD)', data: labels.map(function(){ return capexUsd; }), borderColor:'#ef4444', fill:false, tension:0.3 }
                      ]}, options:{ plugins:{ legend:{ display:true }}, scales:{ y:{ beginAtZero:true, ticks:{ callback:function(v){ return '$'+v; }}} } });
                    }
                  } catch(e){}
                  })
                  .catch(function(){ document.getElementById('econ').innerHTML = '—'; });
              });
            })
            .catch(function(e){
              document.getElementById('proj-measurements').innerHTML = 'Error de red.';
            });
        });
      }

      // Modal functionality
      document.addEventListener('DOMContentLoaded', function(){
        var modal = document.getElementById('measurements-modal');
        var openBtn = document.getElementById('view-measurements-btn');
        var closeBtn = document.getElementById('close-modal');
        
        if (openBtn) {
          openBtn.addEventListener('click', function(){
            modal.classList.remove('hidden');
          });
        }
        
        if (closeBtn) {
          closeBtn.addEventListener('click', function(){
            modal.classList.add('hidden');
          });
        }
        
        // Cerrar modal al hacer clic fuera
        modal.addEventListener('click', function(e){
          if (e.target === modal) {
            modal.classList.add('hidden');
          }
        });
      });

      loadProject();
      loadMeasurements();
    </script>
  </body>
  </html>




