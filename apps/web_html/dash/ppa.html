<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>We Win • PPA</title>
    <link rel="stylesheet" href="/src/style.css" />
    <script src="https://unpkg.com/htmx.org@1.9.12" defer></script>
  </head>
  <body class="min-h-screen">
    <div class="mx-auto max-w-6xl px-6 py-8 space-y-8">
      <div hx-get="/partials/navbar.html" hx-trigger="load" hx-swap="outerHTML"></div>
      <h1 class="text-2xl font-semibold">Crear PPA</h1>

      <section class="card">
        <h2 class="text-lg font-semibold mb-3">Paso 1: Seleccionar oferta</h2>
        <div id="step1" hx-get="http://localhost:8001/api/offers/public" hx-trigger="load" hx-swap="innerHTML">Cargando ofertas...</div>
      </section>
      <section class="card">
        <h2 class="text-lg font-semibold mb-3">Paso 2: Seleccionar demanda</h2>
        <div id="step2" hx-get="http://localhost:8001/api/demands/public" hx-trigger="load" hx-swap="innerHTML">Cargando demandas...</div>
      </section>
      <section class="card">
        <h2 class="text-lg font-semibold mb-3">Paso 3: Crear contrato</h2>
        <form class="space-y-3" hx-post="http://localhost:8001/api/demands/ppa/create" hx-target="#ppa-flash" hx-swap="innerHTML">
          <div class="grid md:grid-cols-3 gap-2">
            <input name="offer_id" placeholder="offer_id" required />
            <input name="demand_id" placeholder="demand_id" required />
            <input name="proyecto_id" placeholder="proyecto_id" required />
          </div>
          <button class="btn-primary">Crear PPA</button>
        </form>
        <div id="ppa-flash" class="text-sm text-[color:var(--text-secondary)] mt-2"></div>
      </section>

      <section class="card">
        <h2 class="text-lg font-semibold mb-3">Estado y liquidación</h2>
        <form class="flex gap-2 items-center" onsubmit="event.preventDefault(); loadEstado();">
          <input id="ppa_id" placeholder="ppa_id" required />
          <button class="btn-primary" type="button" onclick="loadEstado()">Ver estado</button>
          <button class="btn-primary" type="button" onclick="simulate()">Simular Liquidación</button>
        </form>
        <div id="ppa-estado" class="mt-3"></div>
      </section>
    </div>
    <script>
      const API = 'http://localhost:8001';
      document.addEventListener('htmx:configRequest', (evt) => {
        const token = localStorage.getItem('access');
        if (token) evt.detail.headers['Authorization'] = 'Bearer ' + token;
      });
      async function loadEstado(){
        const id = document.getElementById('ppa_id').value;
        if(!id) return;
        const res = await fetch(`${API}/api/demands/${id}/ppa/estado`);
        const data = await res.json();
        document.getElementById('ppa-estado').innerHTML = `<div class="badge-kpi">kWh ${data.kwh} • Tarifa ${data.tarifa} • Neto ${data.neto}</div>`;
      }
      async function simulate(){
        // usa management command vía backend manualmente por ahora (se lanza por consola)
        alert('Para demo: ejecuta manage.py liquidate_ppas en backend. Luego refresca estado.');
      }
    </script>
  </body>
  </html>




